{% extends "base.html" %}

{% block content %}

<div class="container my-2">
    <div class="accordion" id="settingsFormsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="oneSFormHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#oneSFormCollapse" aria-expanded="false" aria-controls="oneSFormCollapse">
                    Настройка приложения
                </button>
            </h2>
            <div id="oneSFormCollapse" class="accordion-collapse collapse" aria-labelledby="oneSFormHeading" data-bs-parent="#settingsFormsAccordion">
                <div class="accordion-body">
                    <form method="POST" action="{{ url_for('main.save_app_settings') }}" enctype="multipart/form-data">
                        <div class="row my-3">
                            {{ forms['app'].csrf_token(id=False) }}
                            {{ forms['app'].email.label(class_ = 'col-md-2 form-label') }}
                            <div class="col-md-10">
                                {{ forms['app'].email(class_ = 'form-control') }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-10 offset-md-2">
                                <div class="form-check">
                                    {{ forms['app'].enable(class_ = 'form-check-input') }}
                                    {{ forms['app'].enable.label(class_ = 'form-check-label') }}
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            {{ forms['app'].order_id_bias.label(class_ = 'col-md-2 form-label') }}
                            <div class="col-md-10">
                                {{ forms['app'].order_id_bias(class_ = 'form-control') }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            {{ forms['app'].image.label(class_ = 'col-md-2 form-label') }}
                            <div class="col-md-10">
                                {{forms['app'].image(class_='form-control', accept='image/png')}}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                {{ forms['app'].submit(id=False, class_ = 'btn btn-primary text-white') }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header" id="categoriesFormHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#categoriesFormCollapse" aria-expanded="false" aria-controls="categoriesFormCollapse">
                    Категории
                </button>
            </h2>
            <div id="categoriesFormCollapse" class="accordion-collapse collapse" aria-labelledby="categoriesFormHeading" data-bs-parent="#settingsFormsAccordion">
                <div class="accordion-body">
                    <div class="row">
                        <div class="col">
                            <input class="form-control" id="categoryFilter" type="text" placeholder="Фильтр..">
                        </div>
                        <div class="col-auto">
                            <a class="btn btn-primary text-white" href="#" role="button" data-bs-toggle="modal" data-bs-target="#addCategoryModal"><i class="bi bi-plus-square"></i></a>
                        </div>
                    </div>
                    <div class="row d-none d-sm-flex fw-bold">
                        <div class="col overflow-hidden">
                            Название
                        </div>
                        <div class="col overflow-hidden">
                            Ответственный/ФДБ/БДР/БДДС/Код
                        </div>
                    </div>
                    <div id="categoryList">
                        {% for category in categories %}
                            <div class="row my-1 py-1 border-bottom">
                                <div class="col-sm">
                                    <span class="d-sm-none fw-bold">Название:</span>
                                    {{ category.name }}
                                </div>
                                <div class="col-sm">
                                    <form class="categoryForm" action="{{ url_for('main.edit_category') }}" method="POST" id="categoryForm{{category.id}}"  enctype="multipart/form-data">
                                        <div class="row py-1">
                                            <div class="col">
                                                {{ forms['edit_category'].csrf_token(id=False) }}
                                                {{ forms['edit_category'].category_id(class_ = 'd-none', hidden = '', value=category.id, id=False) }}
                                                {{ forms['edit_category'].responsible(class_ = 'form-select responsible', id=False, value = category.responsible.id or 0) }}
                                            </div>
                                            <div class="col">
                                                {{ forms['edit_category'].budget_holder(class_ = 'form-select budget_holder', id=False, value = category.budget_holder or 0) }}
                                            </div>
                                            <div class="col">
                                                {{ forms['edit_category'].code(class_ = 'form-control code', id=False, placeholder='Код', value = category.code or '') }}
                                            </div>
                                        </div>
                                        <div class="row py-1">
                                            <div class="col">
                                                {{ forms['edit_category'].income(class_ = 'form-select income', id=False, placeholder='БДР', value = category.income.id or 0) }}
                                            </div>
                                            <div class="col">
                                                {{ forms['edit_category'].cashflow(class_ = 'form-select cashflow', id=False, placeholder='БДДС', value = category.cashflow.id or 0) }}
                                            </div>
                                        </div>
                                        <div class="row py-1">
                                            <div class="col">
                                                {{forms['edit_category'].image(class_='form-control', accept='image/*')}}
                                            </div>
                                            <div class="col-auto text-end">
                                                {{ forms['edit_category'].submit(id=False, class_='btn btn-primary text-white') }}
                                            </div>
                                        </div>
                                    </form>
                                    <form action="{{url_for('main.remove_category', category_id=category.id)}}" method="POST">
                                        <div class="row">
                                            <div class="col text-end">
                                                <button class="btn btn-danger text-white" onclick="return confirm('Вы действительно хотите удалить?')">Удалить</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header" id="projectsFormHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#projectsFormCollapse" aria-expanded="false" aria-controls="projectsFormCollapse">
                    Проекты
                </button>
            </h2>
            <div id="projectsFormCollapse" class="accordion-collapse collapse" aria-labelledby="projectsFormHeading" data-bs-parent="#settingsFormsAccordion">
                <div class="accordion-body">
                    <div class="row">
                        <div class="col">
                            <input class="form-control" id="projectFilter" type="text" placeholder="Фильтр..">
                        </div>
                        <div class="col-auto">
                            <a class="btn btn-primary text-white" href="#" role="button" data-bs-toggle="modal" data-bs-target="#addProjectModal"><i class="bi bi-plus-square"></i></a>
                        </div>
                    </div>
                    <div class="row d-none d-sm-flex fw-bold">
                        <div class="col overflow-hidden">
                            Название
                        </div>
                        <div class="col overflow-hidden">
                            Код
                        </div>
                        <div class="col overflow-hidden">
                            (Код) Объекты
                        </div>
                    </div>
                    <div id="projectList">
                        {% for project in projects %}
                            <div class="row my-1 py-1 border-bottom">
                                <div class="col-sm">
                                    <form action="{{url_for('main.remove_project', project_id=project.id)}}" method="POST">
                                        <div class="row">
                                            <div class="col">
                                                <span class="d-sm-none fw-bold">Название:</span>
                                                <a class="editProjectButton" href="#" data-bs-toggle="modal" data-bs-target="#editProjectModal" data-id="{{ project.id }}">
                                                    {{ project.name }}
                                                </a>
                                            </div>
                                            <div class="col-auto">
                                                <a class="addSiteButton btn btn-sm btn-primary" href="#" data-bs-toggle="modal" data-bs-target="#addSiteModal" data-id="{{ project.id }}">
                                                    <i class="bi bi-plus-square"></i>
                                                </a>
                                                <button class="btn btn-outline-danger btn-sm rounded" type="submit" onclick="return confirm('Вы действительно хотите удалить?')">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-sm">
                                    <span class="d-sm-none fw-bold">Код:</span>
                                    {{ project.uid or '' }}
                                </div>
                                <div class="col-sm">
                                    {% for site in project.sites %}
                                        <form action="{{url_for('main.remove_site', site_id=site.id)}}" method="POST" class="my-1">
                                            <div class="row">
                                                <div class="col">
                                                    <span class="d-sm-none fw-bold">(Код) Объект:</span>
                                                    <a class="editSiteButton" href="#" data-bs-toggle="modal" data-bs-target="#editSiteModal" data-id="{{ site.id }}">
                                                        ({{ site.uid or ' ' }})
                                                        {{ site.name }}
                                                    </a>
                                                </div>
                                                <div class="col-auto">
                                                    <button class="btn btn-outline-danger btn-sm rounded" type="submit" onclick="return confirm('Вы действительно хотите удалить?')">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header" id="statementsFormHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#statementsFormCollapse" aria-expanded="false" aria-controls="statementsFormCollapse">
                    БДР, БДДС, ФДБ
                </button>
            </h2>
            <div id="statementsFormCollapse" class="accordion-collapse collapse" aria-labelledby="statementsFormHeading" data-bs-parent="#settingsFormsAccordion">
                <div class="accordion-body">
                    <div class="row">
                        <div class="col">
                            <input class="form-control" id="statementsFilter" type="text" placeholder="Фильтр..">
                        </div>
                        <div class="col-auto">
                            <a class="btn btn-primary text-white addIncomeButton" href="#" role="button" data-bs-toggle="modal" data-bs-target="#addIncomeModal"><i class="bi bi-plus"></i>БДР</a>
                        </div>
                        <div class="col-auto">
                            <a class="btn btn-primary text-white addCashflowButton" href="#" role="button" data-bs-toggle="modal" data-bs-target="#addCashflowModal"><i class="bi bi-plus"></i>БДДС</a>
                        </div>
                        <div class="col-auto">
                            <a class="btn btn-primary text-white addBudgetHolderButton" href="#" role="button" data-bs-toggle="modal" data-bs-target="#budgetHolderModal"><i class="bi bi-plus"></i>ФДБ</a>
                        </div>
                    </div>
                    <div class="row d-none d-sm-flex fw-bold">
                        <div class="col overflow-hidden">
                            БДР
                        </div>
                        <div class="col overflow-hidden">
                            БДДС
                        </div>
                        <div class="col overflow-hidden">
                            ФДБ
                        </div>
                    </div>
                    <div class="row my-1 py-1 border-bottom">
                        <div class="col">
                            {% for income in incomes %}
                                <form action="{{url_for('main.remove_income', income_id=income.id)}}" method="POST" class="my-1">
                                    <div class="row">
                                        <div class="col-auto">
                                            <button class="btn btn-outline-danger btn-sm rounded" type="submit" onclick="return confirm('Вы действительно хотите удалить?')">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                        <div class="col">
                                            <span class="d-sm-none fw-bold">БДР:</span>
                                            <a class="editIncomeButton" href="#" data-bs-toggle="modal" data-bs-target="#editIncomeModal" data-id="{{ income.id }}">
                                                {{ income.name }}
                                            </a>
                                        </div>
                                    </div>
                                </form>
                            {% endfor %}
                        </div>
                        <div class="col">
                            {% for cashflow in cashflows %}
                                <form action="{{url_for('main.remove_cashflow', cashflow_id=cashflow.id)}}" method="POST" class="my-1">
                                    <div class="row">
                                        <div class="col-auto">
                                            <button class="btn btn-outline-danger btn-sm rounded" type="submit" onclick="return confirm('Вы действительно хотите удалить?')">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                        <div class="col">
                                            <span class="d-sm-none fw-bold">БДДС:</span>
                                            <a class="editCashflowButton" href="#" data-bs-toggle="modal" data-bs-target="#editCashflowModal" data-id="{{ cashflow.id }}">
                                                {{ cashflow.name }}
                                            </a>
                                        </div>
                                    </div>
                                </form>
                            {% endfor %}
                        </div>
                        <div class="col">
                            {% for budget_holder in budget_holders %}
                                <form action="{{url_for('main.remove_budget_holder', budget_holder_id=budget_holder.id)}}" method="POST" class="my-1">
                                    <div class="row">
                                        <div class="col-auto">
                                            <button class="btn btn-outline-danger btn-sm rounded" type="submit" onclick="return confirm('Вы действительно хотите удалить?')">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                        <div class="col">
                                            <span class="d-sm-none fw-bold">ФДБ:</span>
                                            <a class="editBudgetHolderButton" href="#" data-bs-toggle="modal" data-bs-target="#budgetHolderModal" data-id="{{ budget_holder.id }}">
                                                {{ budget_holder.name }}
                                            </a>
                                        </div>
                                    </div>
                                </form>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">ДОБАВИТЬ КАТЕГОРИЮ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.add_category') }}">
                <div class="modal-body">
                    {{ forms['add_category'].csrf_token(id=False) }}
                    <div class="mb-3">
                        {{ forms['add_category'].category_name.label(id=False, class_='form-label', for='addCategoryName') }}
                        {{ forms['add_category'].category_name(id='addCategoryName', class_='form-control') }}
                    </div>
                </div>
                <div class="modal-footer">
                    {{ forms['add_category'].submit(id=False, class_='btn btn-primary text-white') }}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProjectModalLabel">ДОБАВИТЬ ПРОЕКТ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.add_project') }}">
                <div class="modal-body">
                    {{ forms['add_project'].csrf_token(id=False) }}
                    <div class="mb-3">
                        {{ forms['add_project'].project_name.label(id=False, class_='form-label', for='addProjectName') }}
                        {{ forms['add_project'].project_name(id='addProjectName', class_='form-control') }}
                    </div>
                    <div class="mb-3">
                        {{ forms['add_project'].uid.label(id=False, class_='form-label', for='addProjectUid') }}
                        {{ forms['add_project'].uid(id='addProjectUid',class_='form-control') }}
                    </div>
                </div>
                <div class="modal-footer">
                    {{ forms['add_project'].submit(id=False, class_='btn btn-primary text-white') }}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addSiteModal" tabindex="-1" aria-labelledby="addSiteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSiteModalLabel">ДОБАВИТЬ ОБЪЕКТ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.add_site') }}">
                <div class="modal-body">
                    {{ forms['add_site'].csrf_token(id=False) }}
                    {{ forms['add_site'].project_id(id='addSiteProjectId', hidden='', class_='d-none') }}
                    <div class="mb-3">
                        {{ forms['add_site'].site_name.label(id=False, class_='form-label', for='addSiteName') }}
                        {{ forms['add_site'].site_name(id='addSiteName', class_='form-control') }}
                    </div>
                    <div class="mb-3">
                        {{ forms['add_site'].uid.label(id=False, class_='form-label', for='addSiteUid') }}
                        {{ forms['add_site'].uid(id='addSiteUid',class_='form-control') }}
                    </div>
                </div>
                <div class="modal-footer">
                    {{ forms['add_site'].submit(id=False, class_='btn btn-primary text-white') }}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProjectModalLabel">РЕДАКТИРОВАТЬ ПРОЕКТ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.edit_project') }}">
                <div class="modal-body">
                    {{ forms['edit_project'].csrf_token(id=False) }}
                    {{ forms['edit_project'].project_id(id='editProjectId', hidden='', class_='d-none') }}
                    <div class="mb-3">
                        {{ forms['edit_project'].project_name.label(id=False, class_='form-label', for='editProjectName') }}
                        {{ forms['edit_project'].project_name(id='editProjectName', class_='form-control') }}
                    </div>
                    <div class="mb-3">
                        {{ forms['edit_project'].uid.label(id=False, class_='form-label', for='editProjectUid') }}
                        {{ forms['edit_project'].uid(id='editProjectUid',class_='form-control') }}
                    </div>
                    <div class="mb-3 form-check">
                        {{ forms['edit_project'].enabled(id='editProjectEnabled',class_='form-check-input') }}
                        {{ forms['edit_project'].enabled.label(id=False, class_='form-check-label', for='editProjectEnabled') }}
                    </div>
                </div>
                <div class="modal-footer">
                    {{ forms['edit_project'].submit(id=False, class_='btn btn-primary text-white') }}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editSiteModal" tabindex="-1" aria-labelledby="editSiteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSiteModalLabel">РЕДАКТИРОВАТЬ ОБЪЕКТ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.edit_site') }}">
                <div class="modal-body">
                    {{ forms['edit_site'].csrf_token(id=False) }}
                    {{ forms['edit_site'].site_id(id='editSiteId', hidden='', class_='d-none') }}
                    <div class="mb-3">
                        {{ forms['edit_site'].site_name.label(id=False, class_='form-label', for='editSiteName') }}
                        {{ forms['edit_site'].site_name(id='editSiteName', class_='form-control') }}
                    </div>
                    <div class="mb-3">
                        {{ forms['edit_site'].uid.label(id=False, class_='form-label', for='editSiteUid') }}
                        {{ forms['edit_site'].uid(id='editSiteUid',class_='form-control') }}
                    </div>
                </div>
                <div class="modal-footer">
                    {{ forms['edit_site'].submit(id=False, class_='btn btn-primary text-white') }}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addIncomeModal" tabindex="-1" aria-labelledby="addIncomeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addIncomeModalLabel">ДОБАВИТЬ БДР</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.add_income') }}">
                <div class="modal-body">
                    {{ forms['add_income'].csrf_token(id=False) }}
                    <div class="mb-3">
                        {{ forms['add_income'].income_name.label(id=False, class_='form-label', for='addIncomeName') }}
                        {{ forms['add_income'].income_name(id='addIncomeName', class_='form-control') }}
                    </div>
                </div>
                <div class="modal-footer">
                    {{ forms['add_income'].submit(id=False, class_='btn btn-primary text-white') }}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="budgetHolderModal" tabindex="-1" aria-labelledby="budgetHolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="budgetHolderModalLabel">ДОБАВИТЬ ФДБ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.add_budget_holder') }}" id="budgetHolderForm">
                <div class="modal-body">
                    {{ forms['budget_holder'].csrf_token(id=False) }}
                    <div class="mb-3">
                        {{ forms['budget_holder'].budget_holder_name.label(id=False, class_='form-label', for='budgetHolderName') }}
                        {{ forms['budget_holder'].budget_holder_name(id='budgetHolderName', class_='form-control') }}
                    </div>
                </div>
                <div class="modal-footer">
                    {{ forms['budget_holder'].submit(id=False, class_='btn btn-primary text-white') }}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addCashflowModal" tabindex="-1" aria-labelledby="addCashflowModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCashflowModalLabel">ДОБАВИТЬ БДДС</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.add_cashflow') }}">
                <div class="modal-body">
                    {{ forms['add_cashflow'].csrf_token(id=False) }}
                    <div class="mb-3">
                        {{ forms['add_cashflow'].cashflow_name.label(id=False, class_='form-label', for='addCashflowName') }}
                        {{ forms['add_cashflow'].cashflow_name(id='addCashflowName', class_='form-control') }}
                    </div>
                </div>
                <div class="modal-footer">
                    {{ forms['add_cashflow'].submit(id=False, class_='btn btn-primary text-white') }}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="editIncomeModal" tabindex="-1" aria-labelledby="editIncomeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editIncomeModalLabel">РЕДАКТИРОВАТЬ БДР</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.edit_income') }}">
                <div class="modal-body">
                    {{ forms['edit_income'].csrf_token(id=False) }}
                    {{ forms['edit_income'].income_id(id='editIncomeId', hidden='', class_='d-none') }}
                    <div class="mb-3">
                        {{ forms['edit_income'].income_name.label(id=False, class_='form-label', for='editIncomeName') }}
                        {{ forms['edit_income'].income_name(id='editIncomeName', class_='form-control') }}
                    </div>
                </div>
                <div class="modal-footer">
                    {{ forms['edit_income'].submit(id=False, class_='btn btn-primary text-white') }}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="editCashflowModal" tabindex="-1" aria-labelledby="editCashflowModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCashflowModalLabel">РЕДАКТИРОВАТЬ БДДС</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.edit_cashflow') }}">
                <div class="modal-body">
                    {{ forms['edit_cashflow'].csrf_token(id=False) }}
                    {{ forms['edit_cashflow'].cashflow_id(id='editCashflowId', hidden='', class_='d-none') }}
                    <div class="mb-3">
                        {{ forms['edit_cashflow'].cashflow_name.label(id=False, class_='form-label', for='editCashflowName') }}
                        {{ forms['edit_cashflow'].cashflow_name(id='editCashflowName', class_='form-control') }}
                    </div>
                </div>
                <div class="modal-footer">
                    {{ forms['edit_cashflow'].submit(id=False, class_='btn btn-primary text-white') }}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {

        var projects = {{projects|to_json|safe}};
        
        var incomes = {{incomes|to_json|safe}};
        
        var cashflows = {{cashflows|to_json|safe}};
        
        var budget_holders = {{budget_holders|to_json|safe}};

        var categories = {{categories|to_json|safe}};

        var responsibles = {{responsibles|to_json|safe}};


        for (let i = 0; i < categories.length; i++) {
            let cat = categories[i];
            let form = $("#categoryForm"+cat["id"]);
            console.log(cat?.income?.name);
            let income_id = cat?.income || 0;
            let cashflow_id = cat?.cashflow || 0;
            let responsible_id = cat?.responsible?.id || 0;
            let budget_holder_id = cat?.budget_holder || 0;

            form.find(".income option[value='"+income_id+"']").prop("selected", true);
            form.find(".cashflow option[value='"+cashflow_id+"']").prop("selected", true);
            form.find(".budget_holder option[value='"+budget_holder_id+"']").prop("selected", true);
            form.find(".responsible option[value='"+responsible_id+"']").prop("selected", true);
        }


        $(".addBudgetHolderButton").click(function () {
            $('#budgetHolderModalLabel').text('ДОБАВИТЬ ФДБ');
            $("#budgetHolderForm").prop("action", "{{ url_for('main.add_budget_holder') }}");
            $("#budgetHolderName").val(null);
        });

        $(".editBudgetHolderButton").click(function () {
            let budgetHolderId = Number($(this).data("id"));
            $('#budgetHolderModalLabel').text('РЕДАКТИРОВАТЬ ФДБ');
            $("#budgetHolderForm").prop("action", "{{ url_for('main.edit_budget_holder', budget_holder_id=0) }}".replace(0, budgetHolderId));
            budget_holders.some(function (budget_holder) {
                if (budget_holder["id"] == budgetHolderId) {
                    $("#budgetHolderName").val(budget_holder["name"]);
                    return true;
                }
            });
        });

        $(".editIncomeButton").click(function () {
            let incomeId = Number($(this).data("id"));
            $("#editIncomeId").val(incomeId);
            $("#removeIncomeButton").prop("href", "{{ url_for('main.remove_income', income_id=0) }}".replace(0, incomeId));
            incomes.some(function (income) {
                if (income["id"] == incomeId) {
                    $("#editIncomeName").val(income["name"]);
                    return true;
                }
            });
        });

        $(".editCashflowButton").click(function () {
            let cashflowId = Number($(this).data("id"));
            $("#editCashflowId").val(cashflowId);
            $("#removeCashflowButton").prop("href", "{{ url_for('main.remove_cashflow', cashflow_id=0) }}".replace(0, cashflowId));
            cashflows.some(function (cashflow) {
                if (cashflow["id"] == cashflowId) {
                    $("#editCashflowName").val(cashflow["name"]);
                    return true;
                }
            });
        });


        $(".editProjectButton").click(function () {
            let projectId = Number($(this).data("id"));
            $("#editProjectId").val(projectId);
            $("#removeProjectButton").prop("href", "{{ url_for('main.remove_project', project_id=0) }}".replace(0, projectId));
            projects.some(function (project) {
                if (project["id"] == projectId) {
                    $("#editProjectName").val(project["name"]);
                    $("#editProjectUid").val(project["uid"]);
                    $("#editProjectEnabled").prop('checked', project["enabled"]);
                    return true;
                }
            });
        });

        $(".addSiteButton").click(function () {
            let projectId = Number($(this).data("id"));
            $("#addSiteProjectId").val(projectId);
            projects.some(function (project) {
                if (project["id"] == projectId) {
                    $("#addSiteModalLabel").text("ДОБАВИТЬ ОБЪЕКТ В \"" + project["name"] + "\"");
                    return true;
                }
            });
        });

        $(".editSiteButton").click(function () {
            let siteId = Number($(this).data("id"));
            $("#editSiteId").val(siteId);
            $("#removeSiteButton").prop("href", "{{ url_for('main.remove_site', site_id=0) }}".replace(0, siteId));
            projects.some(function (project) {
                let found = false;
                project["sites"].some(function (site) {
                    if (site["id"] == siteId) {
                        $("#editSiteName").val(site["name"]);
                        $("#editSiteUid").val(site["uid"]);
                        found = true;
                        return true;
                    }
                });
                if (found === true)
                    return true;
            });
        });

        $("#projectFilter").on("keyup", function () {
            let value = $(this).val().toLowerCase();
            $("#projectList .row").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });
        $("#categoryFilter").on("keyup", function () {
            let value = $(this).val().toLowerCase();
            $("#categoryList .row").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });

        $("#statementsFilter").on("keyup", function () {
            let value = $(this).val().toLowerCase();
            $(".statement.row").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });

        $(".income option[value='0']").prop("disabled", true);
        $(".cashflow option[value='0']").prop("disabled", true);
        $(".budget_holder option[value='0']").prop("disabled", true);
        $(".responsible option[value='0']").prop("disabled", true);

        $("#project_name").on('input', function () {
            let val = this.value;
            let sitesList = $("#sitesList");
            sitesList.empty();
            for (let i = 0, locLen = projects.length; i < locLen; i++) {
                loc = projects[i];
                if (loc["name"].toUpperCase() === val.toUpperCase()) {
                    for (j = 0, siteLen = loc["sites"].length; j < siteLen; j++) {
                        sitesList.append($("<option>").text(loc["sites"][j]["name"]));
                    }
                    break;
                }
            }
        });
    });
</script>
{% endblock %}